<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°è´¨è¡¨æ ¼ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <style>
        /* ä¿ç•™åŸæœ‰æ ·å¼ */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .container {
            max-width: 1200px;
        }

        #app {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .nav-link {
            color: #2c3e50;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        /* æ·»åŠ ä¸€äº›æ–°æ ·å¼ */
        .table-selection {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .merge-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .checkbox-label input {
            margin-right: 5px;
        }

        /* æ–°å¢æ ·å¼ */
        .table-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-group-sm {
            margin-right: 10px;
        }

        .table-toolbar {
            background-color: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .history-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 10px;
        }

        .cell-action-btn {
            background: none;
            border: none;
            color: #007bff;
            padding: 0 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .cell-action-btn:hover {
            color: #0056b3;
        }

        .row-col-actions {
            position: relative;
        }

        .action-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 5px 0;
        }

        .action-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 5px 15px;
            border: none;
            background: none;
            cursor: pointer;
        }

        .action-dropdown button:hover {
            background-color: #f1f1f1;
        }

        .col-indicator {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 2px 0;
            border-bottom: 1px solid #ddd;
        }

        .row-indicator {
            width: 40px;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 2px 0;
            border-right: 1px solid #ddd;
            user-select: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>åœ°è´¨è¡¨æ ¼ç¼–è¾‘å™¨</h1>
            <a href="/" class="nav-link">è¿”å›RDFæœç´¢ç³»ç»Ÿ</a>
        </div>

        <div id="app">
            <!-- Vueåº”ç”¨å°†åœ¨è¿™é‡ŒæŒ‚è½½ -->
        </div>
    </div>

    <!-- å¼•å…¥Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

    <!-- å¼•å…¥Axiosç”¨äºHTTPè¯·æ±‚ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- è¡¨æ ¼ç¼–è¾‘å™¨ç»„ä»¶ä»£ç  -->
    <script>
        // è¡¨æ ¼ç¼–è¾‘å™¨ç»„ä»¶
        const TableEditor = {
            template: `
        <div class="table-editor">
          <div v-if="loading" class="alert alert-info">
            <div class="spinner-border spinner-border-sm mr-2" role="status"></div>
            åŠ è½½è¡¨æ ¼æ•°æ®ä¸­...
          </div>
          
          <div v-else-if="error" class="alert alert-danger">
            <strong>é”™è¯¯:</strong> {{ error }}
          </div>
          
          <div v-else>
            <!-- è¡¨æ ¼é€‰æ‹©å’Œåˆå¹¶åŒºåŸŸ -->
            <div class="table-selection" v-if="mergeMode">
              <h4>è¡¨æ ¼åˆå¹¶æ¨¡å¼</h4>
              <p>é€‰æ‹©è¦åˆå¹¶çš„è¡¨æ ¼ï¼š</p>
              
              <div class="merge-options">
                <div v-for="(table, index) in tables" :key="index" class="checkbox-label">
                  <input type="checkbox" :id="'table-' + index" v-model="tablesToMerge[index]">
                  <label :for="'table-' + index">
                    è¡¨æ ¼ {{ index + 1 }} 
                    <span v-if="table.is_cross_page" class="badge badge-warning">è·¨é¡µ</span>
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label for="mergedTableName">åˆå¹¶åçš„è¡¨æ ¼åç§°:</label>
                <input type="text" id="mergedTableName" v-model="mergedTableName" class="form-control" placeholder="è¾“å…¥åˆå¹¶åçš„è¡¨æ ¼åç§°">
              </div>
              
              <div class="btn-group">
                <button @click="performMerge" class="btn btn-success" :disabled="!canMerge">
                  æ‰§è¡Œåˆå¹¶
                </button>
                <button @click="cancelMerge" class="btn btn-secondary">
                  å–æ¶ˆ
                </button>
                    <button @click="mergeMode = false" class="btn btn-danger" style="margin-left: 10px;">
      ç´§æ€¥è¿”å›
    </button>
              </div>
            </div>
            
            <!-- å¸¸è§„è¡¨æ ¼é€‰æ‹©å’Œç¼–è¾‘åŒºåŸŸ -->
            <div v-else>
              <div class="form-group">
                <label for="tableSelector">é€‰æ‹©è¡¨æ ¼:</label>
                <select id="tableSelector" class="form-control" v-model="currentTableIndex" @change="loadTable">
                  <option v-for="(table, index) in tables" :key="index" :value="index">
                    è¡¨æ ¼ {{ index + 1 }} ({{ table.table_type || 'æœªçŸ¥ç±»å‹' }})
                    <span v-if="table.suspicious_count > 0" class="text-danger">
                      - {{ table.suspicious_count }}ä¸ªéœ€è¦å®¡æ ¸
                    </span>
                  </option>
                </select>
              </div>
              
              <div v-if="currentTable" class="mb-4">
                <div class="alert" :class="{'alert-warning': currentTable.is_cross_page, 'alert-secondary': !currentTable.is_cross_page}">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <span>{{ currentTable.is_cross_page ? 'âš ï¸ è·¨é¡µè¡¨æ ¼' : 'ğŸ“‹ å•é¡µè¡¨æ ¼' }}</span>
      <span v-if="currentTable.suspicious_count > 0" class="ml-3 badge badge-warning">
        {{ currentTable.suspicious_count }}ä¸ªå¯ç–‘å•å…ƒæ ¼
      </span>
    </div>
    <div class="d-flex align-items-center">
      <span class="mr-2">è¡¨æ ¼åç§°:</span>
      <div v-if="editingTableName">
        <input 
          type="text" 
          v-model="tableNameInput" 
          class="form-control form-control-sm" 
          @blur="finishEditingTableName" 
          @keyup.enter="finishEditingTableName"
          ref="tableNameInput"
        />
      </div>
      <div v-else class="d-flex align-items-center">
        <span>{{ currentTable.table_type || 'æœªçŸ¥ç±»å‹' }}</span>
        <button @click="startEditingTableName" class="btn btn-sm btn-link ml-2">
          <i class="bi bi-pencil"></i>
        </button>
      </div>
    </div>
  </div>
<div class="mt-2">
  <div class="d-flex">
    <div class="mr-4">
      <strong>æºæ–‡ä»¶:</strong> {{ currentTable.source_file || metadata.source_pdf || 'æœªçŸ¥' }}
    </div>
    <div>
      <strong>é¡µç :</strong> {{ currentTable.pages ? currentTable.pages.join(', ') : currentTable.page_idx }}
    </div>
  </div>
</div>
</div>
                
<div class="table-toolbar">
  <div class="d-flex justify-content-between align-items-center">
    <div class="table-actions">
      <div class="btn-group">
        <button @click="saveChanges" :disabled="!hasChanges" class="btn btn-success">
          <i class="bi bi-save"></i> ä¿å­˜ä¿®æ”¹
        </button>
        <button @click="exportToCsv" class="btn btn-secondary">
          <i class="bi bi-filetype-csv"></i> å¯¼å‡ºCSV
        </button>
        <button @click="startMergeMode" class="btn btn-primary">
          <i class="bi bi-object-ungroup"></i> åˆå¹¶è¡¨æ ¼
        </button>
        <button @click="toggleOriginalImages" class="btn btn-info">
          {{ showOriginalImages ? 'éšè—åŸå›¾' : 'æ˜¾ç¤ºåŸå›¾' }}
        </button>
        <button @click="regenerateTableFromPage" class="btn btn-warning">
            <i class="bi bi-arrow-repeat"></i> é‡æ–°ç”Ÿæˆæ­¤é¡µè¡¨æ ¼
        </button>
      </div>
      
      <!-- æ–°å¢çš„è¡Œå’Œåˆ—æ“ä½œæŒ‰é’® -->
      <div class="btn-group ml-2">
        <button class="btn btn-outline-primary dropdown-toggle" @click="toggleRowDropdown">
          <i class="bi bi-list"></i> è¡Œæ“ä½œ
        </button>
        <div class="action-dropdown" v-if="showRowDropdown">
          <button @click="addRow('top')">åœ¨é¡¶éƒ¨æ·»åŠ è¡Œ</button>
          <button @click="addRow('bottom')">åœ¨åº•éƒ¨æ·»åŠ è¡Œ</button>
          <button @click="addRow('current')" :disabled="!selectedRow">åœ¨å½“å‰è¡Œä¸‹æ·»åŠ </button>
          <button @click="deleteRow" :disabled="!selectedRow">åˆ é™¤é€‰ä¸­è¡Œ</button>
        </div>
      </div>
      
      <div class="btn-group ml-2">
        <button class="btn btn-outline-primary dropdown-toggle" @click="toggleColDropdown">
          <i class="bi bi-layout-three-columns"></i> åˆ—æ“ä½œ
        </button>
        <div class="action-dropdown" v-if="showColDropdown">
          <button @click="addColumn('left')">åœ¨å·¦ä¾§æ·»åŠ åˆ—</button>
          <button @click="addColumn('right')">åœ¨å³ä¾§æ·»åŠ åˆ—</button>
          <button @click="addColumn('current')" :disabled="!selectedCol">åœ¨å½“å‰åˆ—åæ·»åŠ </button>
          <button @click="deleteColumn" :disabled="!selectedCol">åˆ é™¤é€‰ä¸­åˆ—</button>
        </div>
      </div>
    </div>
    
    <!-- å†å²è®°å½•æ“ä½œæŒ‰é’® -->
    <div class="btn-group position-relative">
      <button @click="undo" :disabled="!canUndo" class="btn btn-outline-secondary" title="æ’¤é”€">
        <i class="bi bi-arrow-counterclockwise"></i>
        <span v-if="undoStack.length > 0" class="badge badge-secondary history-badge">
          {{ undoStack.length }}
        </span>
      </button>
      <button @click="redo" :disabled="!canRedo" class="btn btn-outline-secondary" title="é‡åš">
        <i class="bi bi-arrow-clockwise"></i>
        <span v-if="redoStack.length > 0" class="badge badge-secondary history-badge">
          {{ redoStack.length }}
        </span>
      </button>
    </div>
  </div>
</div>
                
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
<thead class="thead-light">
  <tr>
    <!-- è¡Œå·åˆ— -->
    <th style="width: 50px; min-width: 50px;">#</th>
    <!-- åˆ—æ ‡è¯†å’Œåˆ—æ“ä½œ -->
    <th v-for="(col, index) in currentTable.header" :key="index" 
        @click="selectColumn(index)"
        :class="{'table-primary': selectedCol === index}">
      <div class="col-indicator">åˆ— {{ index + 1 }}</div>
      {{ col }}
      <div class="float-right">
        <button class="cell-action-btn" @click.stop="editHeader(index)" title="ç¼–è¾‘åˆ—å">
          <i class="bi bi-pencil-square"></i>
        </button>
      </div>
    </th>
  </tr>
</thead>
<tbody>
  <tr v-for="(row, rowIndex) in currentTable.enhanced_rows" :key="rowIndex"
      @click="selectRow(rowIndex)"
      :class="{'table-primary': selectedRow === rowIndex}">
    <!-- è¡Œå·å’Œè¡Œæ“ä½œ -->
    <td class="row-indicator">
      {{ rowIndex + 1 }}
    </td>
    <!-- å•å…ƒæ ¼ -->
    <td v-for="(cell, colIndex) in row" :key="colIndex"
        :class="{'table-warning': cell.suspicious, 'table-primary': selectedCol === colIndex && selectedRow === rowIndex}"
        @click.stop="editCell(rowIndex, colIndex)">
      <span v-if="cell.suspicious" class="badge badge-warning mr-1" :title="cell.reason">
        âš ï¸
      </span>
      <input v-if="editingCell.row === rowIndex && editingCell.col === colIndex"
             v-model="editingCell.value"
             @blur="finishEditing"
             @keyup.enter="finishEditing"
             ref="cellInput"
             class="form-control" />
      <span v-else>{{ cell.value }}</span>
    </td>
  </tr>
</tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div v-if="showOriginalImages && currentTable?.page_images" class="mt-4">
              <h4>åŸå§‹é¡µé¢å›¾åƒ</h4>
              <div v-for="(image, index) in currentTable.page_images" :key="index" class="mb-3">
                <h5>é¡µç  {{ image.page }}</h5>
                <img :src="image.path" :alt="\`é¡µé¢ \${image.page}\`" class="img-fluid border" />
              </div>
            </div>
          </div>
          <!-- ç¼–è¾‘åˆ—æ ‡é¢˜çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="headerEditModal" tabindex="-1" v-if="editingHeader">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¼–è¾‘åˆ—æ ‡é¢˜</h5>
        <button type="button" class="close" @click="cancelHeaderEdit">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>åˆ—æ ‡é¢˜</label>
          <input type="text" class="form-control" v-model="headerEditValue">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @click="cancelHeaderEdit">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" @click="saveHeaderEdit">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>
          <div v-if="statusMessage" class="alert" :class="getAlertClass()" style="position: fixed; bottom: 20px; right: 20px; max-width: 300px;">
            {{ statusMessage }}
          </div>
        </div>
      `,
            data() {
                return {
                    tables: [],
                    metadata: {},
                    currentTableIndex: 0,
                    currentTable: null,
                    editingCell: {
                        row: -1,
                        col: -1,
                        value: ''
                    },
                    originalData: null,
                    hasChanges: false,
                    showOriginalImages: false,
                    loading: true,
                    error: null,
                    statusMessage: null,
                    statusType: 'info',
                    jsonDataPath: '/api/tables',
                    // æ·»åŠ åˆå¹¶è¡¨æ ¼ç›¸å…³å˜é‡
                    mergeMode: false,
                    tablesToMerge: {},
                    mergedTableName: 'åˆå¹¶è¡¨æ ¼',
                    // æ·»åŠ è¡¨æ ¼åç§°ç¼–è¾‘ç›¸å…³å˜é‡
                    editingTableName: false,
                    tableNameInput: '',
                    // åœ¨ data() å‡½æ•°å†…çš„ return å¯¹è±¡ä¸­æ·»åŠ è¿™äº›å±æ€§
                    selectedRow: null,
                    selectedCol: null,
                    showRowDropdown: false,
                    showColDropdown: false,
                    undoStack: [],
                    redoStack: [],
                    editingHeader: false,
                    headerEditIndex: null,
                    headerEditValue: '',
                }
            },
            computed: {
                canUndo() {
                    return this.undoStack.length > 0;
                },
                canRedo() {
                    return this.redoStack.length > 0;
                },
                canMerge() {
                    // æ£€æŸ¥æ˜¯å¦è‡³å°‘é€‰æ‹©äº†ä¸¤ä¸ªè¡¨æ ¼
                    const selectedCount = Object.values(this.tablesToMerge).filter(v => v).length;
                    return selectedCount >= 2 && this.mergedTableName.trim() !== '';
                }
            },
            watch: {
                tablesToMerge: {
                    handler(newVal) {
                        // å¼ºåˆ¶åˆ·æ–°ä»¥ç¡®ä¿æŒ‰é’®çŠ¶æ€æ›´æ–°
                        this.$nextTick(() => this.$forceUpdate());
                    },
                    deep: true
                }
            },
            mounted() {
                this.loadData()
                document.addEventListener('click', this.closeDropdowns);
            },
            beforeDestroy() {
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('click', this.closeDropdowns);
            },
            methods: {
                // å°†å½“å‰çŠ¶æ€ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory() {
                    // ä»…å½“æœ‰è¡¨æ ¼æ—¶æ‰ä¿å­˜å†å²
                    if (!this.currentTable) return;

                    // åˆ›å»ºå½“å‰è¡¨æ ¼çš„æ·±æ‹·è´
                    const snapshot = {
                        header: [...this.currentTable.header],
                        enhanced_rows: JSON.parse(JSON.stringify(this.currentTable.enhanced_rows)),
                        original_rows: this.currentTable.original_rows ?
                            JSON.parse(JSON.stringify(this.currentTable.original_rows)) : null
                    };

                    // æ·»åŠ åˆ°æ’¤é”€æ ˆ
                    this.undoStack.push(snapshot);

                    // é™åˆ¶å†å²è®°å½•é•¿åº¦
                    if (this.undoStack.length > 20) {
                        this.undoStack.shift();
                    }

                    // æ¸…ç©ºé‡åšæ ˆ
                    this.redoStack = [];

                    // æ ‡è®°æœ‰ä¿®æ”¹
                    this.hasChanges = true;
                },

                // æ’¤é”€æ“ä½œ
                undo() {
                    if (!this.canUndo) return;

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšæ ˆ
                    const currentState = {
                        header: [...this.currentTable.header],
                        enhanced_rows: JSON.parse(JSON.stringify(this.currentTable.enhanced_rows)),
                        original_rows: this.currentTable.original_rows ?
                            JSON.parse(JSON.stringify(this.currentTable.original_rows)) : null
                    };
                    this.redoStack.push(currentState);

                    // æ¢å¤å†å²çŠ¶æ€
                    const previousState = this.undoStack.pop();
                    this.currentTable.header = previousState.header;
                    this.currentTable.enhanced_rows = previousState.enhanced_rows;
                    if (previousState.original_rows) {
                        this.currentTable.original_rows = previousState.original_rows;
                    }

                    this.showStatusMessage('å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ', 'info');
                },

                // é‡åšæ“ä½œ
                redo() {
                    if (!this.canRedo) return;

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
                    const currentState = {
                        header: [...this.currentTable.header],
                        enhanced_rows: JSON.parse(JSON.stringify(this.currentTable.enhanced_rows)),
                        original_rows: this.currentTable.original_rows ?
                            JSON.parse(JSON.stringify(this.currentTable.original_rows)) : null
                    };
                    this.undoStack.push(currentState);

                    // æ¢å¤é‡åšçŠ¶æ€
                    const nextState = this.redoStack.pop();
                    this.currentTable.header = nextState.header;
                    this.currentTable.enhanced_rows = nextState.enhanced_rows;
                    if (nextState.original_rows) {
                        this.currentTable.original_rows = nextState.original_rows;
                    }

                    this.showStatusMessage('å·²é‡åšæ“ä½œ', 'info');
                },

                // é€‰æ‹©è¡Œ
                selectRow(rowIndex) {
                    // å¦‚æœå·²é€‰ä¸­åŒä¸€è¡Œï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                    if (this.selectedRow === rowIndex) {
                        this.selectedRow = null;
                    } else {
                        this.selectedRow = rowIndex;
                    }

                    // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
                    this.closeDropdowns();
                },

                // é€‰æ‹©åˆ—
                selectColumn(colIndex) {
                    // å¦‚æœå·²é€‰ä¸­åŒä¸€åˆ—ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                    if (this.selectedCol === colIndex) {
                        this.selectedCol = null;
                    } else {
                        this.selectedCol = colIndex;
                    }

                    // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
                    this.closeDropdowns();
                },

                // æ˜¾ç¤º/éšè—è¡Œæ“ä½œä¸‹æ‹‰èœå•
                toggleRowDropdown(event) {
                    event.stopPropagation();
                    this.showRowDropdown = !this.showRowDropdown;
                    this.showColDropdown = false;
                },

                // æ˜¾ç¤º/éšè—åˆ—æ“ä½œä¸‹æ‹‰èœå•
                toggleColDropdown(event) {
                    event.stopPropagation();
                    this.showColDropdown = !this.showColDropdown;
                    this.showRowDropdown = false;
                },

                // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
                closeDropdowns() {
                    this.showRowDropdown = false;
                    this.showColDropdown = false;
                },

                // æ·»åŠ æ–°è¡Œ
                addRow(position) {
                    if (!this.currentTable) return;

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
                    this.saveToHistory();

                    const numCols = this.currentTable.header.length;
                    // åˆ›å»ºç©ºå•å…ƒæ ¼
                    const newRow = Array(numCols).fill(null).map(() => ({
                        value: '',
                        suspicious: false
                    }));

                    // æ ¹æ®ä½ç½®æ·»åŠ è¡Œ
                    switch (position) {
                        case 'top':
                            this.currentTable.enhanced_rows.unshift(newRow);
                            if (this.currentTable.original_rows) {
                                this.currentTable.original_rows.unshift(Array(numCols).fill(''));
                            }
                            break;
                        case 'bottom':
                            this.currentTable.enhanced_rows.push(newRow);
                            if (this.currentTable.original_rows) {
                                this.currentTable.original_rows.push(Array(numCols).fill(''));
                            }
                            break;
                        case 'current':
                            if (this.selectedRow !== null) {
                                const index = this.selectedRow + 1;
                                this.currentTable.enhanced_rows.splice(index, 0, newRow);
                                if (this.currentTable.original_rows) {
                                    this.currentTable.original_rows.splice(index, 0, Array(numCols).fill(''));
                                }
                                this.selectedRow = index;
                            }
                            break;
                    }

                    // å…³é—­ä¸‹æ‹‰èœå•
                    this.closeDropdowns();
                    this.showStatusMessage('å·²æ·»åŠ æ–°è¡Œ', 'success');
                },

                // åˆ é™¤é€‰ä¸­è¡Œ
                deleteRow() {
                    if (this.selectedRow === null || !this.currentTable) return;

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
                    this.saveToHistory();

                    // åˆ é™¤è¡Œ
                    this.currentTable.enhanced_rows.splice(this.selectedRow, 1);
                    if (this.currentTable.original_rows) {
                        this.currentTable.original_rows.splice(this.selectedRow, 1);
                    }

                    // é‡ç½®é€‰ä¸­çŠ¶æ€
                    this.selectedRow = null;

                    // å…³é—­ä¸‹æ‹‰èœå•
                    this.closeDropdowns();
                    this.showStatusMessage('å·²åˆ é™¤é€‰ä¸­è¡Œ', 'success');
                },

                // æ·»åŠ æ–°åˆ—
                addColumn(position) {
                    if (!this.currentTable) return;

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
                    this.saveToHistory();

                    // æ·»åŠ æ–°çš„åˆ—æ ‡é¢˜
                    const newColumnName = `æ–°åˆ— ${this.currentTable.header.length + 1}`;

                    // æ ¹æ®ä½ç½®æ·»åŠ åˆ—
                    let colIndex;
                    switch (position) {
                        case 'left':
                            colIndex = 0;
                            this.currentTable.header.unshift(newColumnName);
                            break;
                        case 'right':
                            colIndex = this.currentTable.header.length;
                            this.currentTable.header.push(newColumnName);
                            break;
                        case 'current':
                            if (this.selectedCol !== null) {
                                colIndex = this.selectedCol + 1;
                                this.currentTable.header.splice(colIndex, 0, newColumnName);
                                this.selectedCol = colIndex;
                            } else {
                                colIndex = this.currentTable.header.length;
                                this.currentTable.header.push(newColumnName);
                            }
                            break;
                    }

                    // ä¸ºæ¯ä¸€è¡Œæ·»åŠ æ–°å•å…ƒæ ¼
                    this.currentTable.enhanced_rows.forEach(row => {
                        const newCell = { value: '', suspicious: false };
                        row.splice(colIndex, 0, newCell);
                    });

                    // æ›´æ–°åŸå§‹æ•°æ®
                    if (this.currentTable.original_rows) {
                        this.currentTable.original_rows.forEach(row => {
                            row.splice(colIndex, 0, '');
                        });
                    }

                    // å…³é—­ä¸‹æ‹‰èœå•
                    this.closeDropdowns();
                    this.showStatusMessage('å·²æ·»åŠ æ–°åˆ—', 'success');
                },

                // åˆ é™¤é€‰ä¸­åˆ—
                deleteColumn() {
                    if (this.selectedCol === null || !this.currentTable) return;

                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
                    this.saveToHistory();

                    // åˆ é™¤åˆ—æ ‡é¢˜
                    this.currentTable.header.splice(this.selectedCol, 1);

                    // ä»æ¯ä¸€è¡Œä¸­åˆ é™¤å¯¹åº”å•å…ƒæ ¼
                    this.currentTable.enhanced_rows.forEach(row => {
                        row.splice(this.selectedCol, 1);
                    });

                    // æ›´æ–°åŸå§‹æ•°æ®
                    if (this.currentTable.original_rows) {
                        this.currentTable.original_rows.forEach(row => {
                            row.splice(this.selectedCol, 1);
                        });
                    }

                    // é‡ç½®é€‰ä¸­çŠ¶æ€
                    this.selectedCol = null;

                    // å…³é—­ä¸‹æ‹‰èœå•
                    this.closeDropdowns();
                    this.showStatusMessage('å·²åˆ é™¤é€‰ä¸­åˆ—', 'success');
                },

                // ç¼–è¾‘åˆ—æ ‡é¢˜
                editHeader(index) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    event.stopPropagation();

                    this.headerEditIndex = index;
                    this.headerEditValue = this.currentTable.header[index];
                    this.editingHeader = true;

                    // ä½¿ç”¨Bootstrap APIæ˜¾ç¤ºæ¨¡æ€æ¡†
                    $('#headerEditModal').modal('show');
                },

                // å–æ¶ˆç¼–è¾‘åˆ—æ ‡é¢˜
                cancelHeaderEdit() {
                    this.editingHeader = false;
                    this.headerEditIndex = null;
                    this.headerEditValue = '';

                    // ä½¿ç”¨Bootstrap APIéšè—æ¨¡æ€æ¡†
                    $('#headerEditModal').modal('hide');
                },

                // ä¿å­˜åˆ—æ ‡é¢˜ç¼–è¾‘
                saveHeaderEdit() {
                    if (this.headerEditIndex !== null && this.headerEditValue.trim() !== '') {
                        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
                        this.saveToHistory();

                        // æ›´æ–°åˆ—æ ‡é¢˜
                        this.currentTable.header[this.headerEditIndex] = this.headerEditValue.trim();
                        this.showStatusMessage('åˆ—æ ‡é¢˜å·²æ›´æ–°', 'success');
                    }

                    // é‡ç½®ç¼–è¾‘çŠ¶æ€
                    this.cancelHeaderEdit();
                },
                async loadData() {
                    this.loading = true
                    this.error = null

                    try {
                        const response = await axios.get(this.jsonDataPath)
                        const data = response.data

                        this.tables = data.tables || []
                        this.metadata = data.metadata || {}
                        this.originalData = JSON.stringify(data)

                        // åˆå§‹åŒ–åˆå¹¶è¡¨æ ¼é€‰æ‹©çŠ¶æ€
                        this.initMergeSelection()

                        if (this.tables.length > 0) {
                            this.loadTable()
                        } else {
                            this.error = "æœªæ‰¾åˆ°è¡¨æ ¼æ•°æ®"
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¡¨æ ¼æ•°æ®å¤±è´¥:', error)
                        this.error = `åŠ è½½å¤±è´¥: ${error.message}`
                    } finally {
                        this.loading = false
                    }
                },

                initMergeSelection() {
                    // åˆå§‹åŒ–æ‰€æœ‰è¡¨æ ¼ä¸ºæœªé€‰æ‹©çŠ¶æ€
                    this.tablesToMerge = {}
                    this.tables.forEach((_, index) => {
                        this.tablesToMerge[index] = false
                    })
                },

                loadTable() {
                    if (this.tables.length > 0) {
                        this.currentTable = this.tables[this.currentTableIndex]
                        this.editingCell = { row: -1, col: -1, value: '' }
                        // åœ¨ç°æœ‰loadTableæ–¹æ³•ä¸­ï¼Œæ·»åŠ ï¼š
                        this.selectedRow = null;
                        this.selectedCol = null;
                        this.undoStack = [];
                        this.redoStack = [];
                    }
                },

                editCell(rowIndex, colIndex) {
                    const cell = this.currentTable.enhanced_rows[rowIndex][colIndex]
                    this.editingCell = {
                        row: rowIndex,
                        col: colIndex,
                        value: cell.value
                    }

                    // ä¸‹ä¸€å¸§èšç„¦åˆ°è¾“å…¥æ¡†
                    this.$nextTick(() => {
                        if (this.$refs.cellInput) {
                            this.$refs.cellInput.focus()
                        }
                    })
                },

                finishEditing() {
                    const { row, col, value } = this.editingCell;

                    if (row >= 0 && col >= 0) {
                        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
                        this.saveToHistory();

                        // æ›´æ–°å•å…ƒæ ¼å€¼
                        this.currentTable.enhanced_rows[row][col].value = value;

                        // åŒæ—¶æ›´æ–°åŸå§‹è¡Œæ•°æ®ä»¥ä¿æŒä¸€è‡´
                        if (this.currentTable.original_rows &&
                            row < this.currentTable.original_rows.length &&
                            col < this.currentTable.original_rows[row].length) {
                            this.currentTable.original_rows[row][col] = value;
                        }
                    }

                    // é‡ç½®ç¼–è¾‘çŠ¶æ€
                    this.editingCell = { row: -1, col: -1, value: '' };
                },

                async saveChanges() {
                    try {
                        // å‘é€åˆ°æœåŠ¡å™¨
                        await axios.post('/api/tables', {
                            tables: this.tables,
                            metadata: this.metadata
                        });

                        this.hasChanges = false;
                        this.showStatusMessage('ä¿®æ”¹å·²æˆåŠŸä¿å­˜åˆ°æœåŠ¡å™¨', 'success');
                    } catch (error) {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        this.showStatusMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');

                        // å¤‡ä»½åˆ°localStorage
                        localStorage.setItem('tableEditorData', JSON.stringify({
                            tables: this.tables,
                            metadata: this.metadata
                        }));
                        this.showStatusMessage('å·²å¤‡ä»½åˆ°æœ¬åœ°å­˜å‚¨', 'info');
                    }
                },

                exportToCsv() {
                    if (!this.currentTable) return

                    // å‡†å¤‡CSVå†…å®¹
                    const header = this.currentTable.header
                    const rows = this.currentTable.enhanced_rows.map(row =>
                        row.map(cell => cell.value)
                    )

                    // åˆ›å»ºCSVæ–‡æœ¬
                    const csvContent = [
                        header.join(','),
                        ...rows.map(row => row.map(this.escapeCsvValue).join(','))
                    ].join('\r\n')
                    // æ·»åŠ UTF-8 BOMæ ‡è®°
                    const BOM = new Uint8Array([0xEF, 0xBB, 0xBF]);
                    const csvData = new Blob([BOM, csvContent], { type: 'text/csv;charset=utf-8;' })
                    // ä¸‹è½½æ–‡ä»¶
                    const url = URL.createObjectURL(csvData)
                    const link = document.createElement('a')
                    link.href = url
                    link.download = `table_${this.currentTableIndex + 1}.csv`
                    document.body.appendChild(link)
                    link.click()
                    document.body.removeChild(link)

                    this.showStatusMessage('CSVå¯¼å‡ºæˆåŠŸ', 'success')
                },

                escapeCsvValue(value) {
                    if (value === null || value === undefined) return ''

                    value = String(value)
                    // å¦‚æœåŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦ï¼Œç”¨å¼•å·åŒ…è£¹å¹¶è½¬ä¹‰å¼•å·
                    if (value.includes(',') || value.includes('"') || value.includes('\\n')) {
                        return `"${value.replace(/"/g, '""')}"`
                    }
                    return value
                },

                toggleOriginalImages() {
                    this.showOriginalImages = !this.showOriginalImages
                },
                // æ·»åŠ åˆ°methodså¯¹è±¡ä¸­
                regenerateTableFromPage() {
                    const pageIdx = this.currentTable.page_idx;
                    if (!pageIdx) {
                        this.showStatusMessage('æ— æ³•ç¡®å®šé¡µç ', 'error');
                        return;
                    }

                    if (confirm(`ç¡®å®šè¦é‡æ–°ç”Ÿæˆç¬¬${pageIdx}é¡µçš„è¡¨æ ¼å—ï¼Ÿè¿™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ç‹¬ç«‹è¡¨æ ¼ã€‚`)) {
                        // å‘é€è¯·æ±‚åˆ°åç«¯é‡æ–°å¤„ç†ç‰¹å®šé¡µé¢
                        axios.post('/api/regenerate-table', {
                            page: pageIdx,
                            exclude_merge: true
                        }).then(response => {
                            if (response.data.success) {
                                this.showStatusMessage('è¡¨æ ¼å·²é‡æ–°ç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹', 'success');
                                // 1ç§’ååˆ·æ–°é¡µé¢
                                setTimeout(() => window.location.reload(), 1000);
                            } else {
                                this.showStatusMessage('è¡¨æ ¼é‡æ–°ç”Ÿæˆå¤±è´¥: ' + response.data.message, 'error');
                            }
                        }).catch(error => {
                            this.showStatusMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
                        });
                    }
                },
                // å¼€å§‹è¡¨æ ¼åˆå¹¶æ¨¡å¼
                startMergeMode() {
                    this.mergeMode = true
                    // é‡ç½®é€‰æ‹©çŠ¶æ€
                    this.initMergeSelection()
                    // é»˜è®¤é€‰ä¸­å½“å‰è¡¨æ ¼
                    if (this.currentTableIndex !== undefined) {
                        this.tablesToMerge[this.currentTableIndex] = true
                    }

                    // æ·»åŠ è¿™å‡ è¡Œä»£ç ä»¥ç¡®ä¿è®¡ç®—å±æ€§æ›´æ–°
                    this.$nextTick(() => {
                        // å¼ºåˆ¶æ›´æ–°è®¡ç®—å±æ€§
                        this.tablesToMerge = { ...this.tablesToMerge };
                        this.$forceUpdate();
                    });
                },

                // å–æ¶ˆåˆå¹¶æ¨¡å¼
                cancelMerge() {
                    this.mergeMode = false
                },

                // æ‰§è¡Œè¡¨æ ¼åˆå¹¶
                performMerge() {
                    try {
                        console.log("æ‰§è¡Œåˆå¹¶: é€‰ä¸­è¡¨æ ¼æ•°", Object.values(this.tablesToMerge).filter(v => v).length);
                        console.log("åˆå¹¶è¡¨æ ¼åç§°:", this.mergedTableName);

                        if (!this.canMerge) {
                            console.log("æ— æ³•åˆå¹¶:", this.canMerge);
                            return;
                        }

                        // è·å–é€‰ä¸­çš„è¡¨æ ¼ç´¢å¼•
                        const selectedIndices = Object.keys(this.tablesToMerge)
                            .filter(idx => this.tablesToMerge[idx])
                            .map(idx => parseInt(idx));

                        console.log("é€‰ä¸­çš„è¡¨æ ¼ç´¢å¼•:", selectedIndices);

                        // åˆ›å»ºåˆå¹¶åçš„è¡¨æ ¼
                        const mergedTable = this.createMergedTable(selectedIndices);

                        // æ·»åŠ åˆ°è¡¨æ ¼åˆ—è¡¨
                        this.tables.push(mergedTable);

                        // æ›´æ–°å…ƒæ•°æ®
                        if (this.metadata) this.metadata.total_tables = this.tables.length;

                        // é€‰æ‹©æ–°åˆå¹¶çš„è¡¨æ ¼
                        this.currentTableIndex = this.tables.length - 1;
                        this.loadTable();

                        // é€€å‡ºåˆå¹¶æ¨¡å¼
                        this.mergeMode = false;

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showStatusMessage('è¡¨æ ¼åˆå¹¶æˆåŠŸ', 'success');

                        // æ ‡è®°æœ‰ä¿®æ”¹
                        this.hasChanges = true;
                    } catch (err) {
                        console.error('è¡¨æ ¼åˆå¹¶å‡ºé”™:', err);
                        this.showStatusMessage(`è¡¨æ ¼åˆå¹¶å¤±è´¥: ${err.message}`, 'error');
                        // å°è¯•é€€å‡ºåˆå¹¶æ¨¡å¼
                        this.mergeMode = false;
                    }
                },

                // åˆ›å»ºåˆå¹¶åçš„è¡¨æ ¼
                createMergedTable(selectedIndices) {
                    // è·å–ç¬¬ä¸€ä¸ªè¡¨æ ¼ä½œä¸ºåŸºç¡€
                    const baseTable = this.tables[selectedIndices[0]]

                    // åˆ›å»ºæ–°è¡¨æ ¼å¯¹è±¡
                    const mergedTable = {
                        header: [...baseTable.header],
                        enhanced_rows: [],
                        original_rows: [],
                        table_type: this.mergedTableName,
                        is_cross_page: true,
                        pages: [],
                        suspicious_cells: [],
                        suspicious_count: 0
                    }

                    // æ”¶é›†æ‰€æœ‰é¡µç 
                    const allPages = new Set()

                    // åˆå¹¶æ‰€æœ‰è¡Œ
                    selectedIndices.forEach(idx => {
                        const table = this.tables[idx]

                        // æ·»åŠ æ‰€æœ‰é¡µç 
                        if (table.pages) {
                            table.pages.forEach(page => allPages.add(page))
                        } else if (table.page_idx) {
                            allPages.add(table.page_idx)
                        }

                        // æ·»åŠ è¡Œ
                        mergedTable.enhanced_rows = mergedTable.enhanced_rows.concat(table.enhanced_rows)

                        // æ·»åŠ åŸå§‹è¡Œ
                        if (table.original_rows) {
                            mergedTable.original_rows = mergedTable.original_rows.concat(table.original_rows)
                        }

                        // æ”¶é›†å¯ç–‘å•å…ƒæ ¼
                        if (table.suspicious_cells) {
                            // éœ€è¦è°ƒæ•´è¡Œç´¢å¼•
                            const rowOffset = mergedTable.enhanced_rows.length - table.enhanced_rows.length
                            const adjustedSuspiciousCells = table.suspicious_cells.map(cell => ({
                                row: cell.row + rowOffset,
                                col: cell.col,
                                reason: cell.reason
                            }))

                            mergedTable.suspicious_cells = mergedTable.suspicious_cells.concat(adjustedSuspiciousCells)
                        }
                    })

                    // è®¾ç½®é¡µç 
                    mergedTable.pages = Array.from(allPages).sort((a, b) => a - b)

                    // è®¾ç½®å›¾åƒ
                    mergedTable.page_images = mergedTable.pages.map(page => ({
                        page: page,
                        path: `output/images/page_${page}.png`
                    }))

                    // æ›´æ–°å¯ç–‘å•å…ƒæ ¼è®¡æ•°
                    mergedTable.suspicious_count = mergedTable.suspicious_cells.length

                    return mergedTable
                },

                // æ£€æŸ¥ä¸¤ä¸ªè¡¨å¤´æ˜¯å¦å…¼å®¹
                areHeadersCompatible(header1, header2) {
                    if (header1.length !== header2.length) return false

                    // æ£€æŸ¥æ‰€æœ‰åˆ—åæ˜¯å¦ç›¸åŒ
                    for (let i = 0; i < header1.length; i++) {
                        if (header1[i] !== header2[i]) return false
                    }

                    return true
                },

                // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
                showStatusMessage(message, type = 'info') {
                    this.statusMessage = message
                    this.statusType = type

                    // 5ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
                    setTimeout(() => {
                        this.statusMessage = null
                    }, 5000)
                },

                getAlertClass() {
                    switch (this.statusType) {
                        case 'success': return 'alert-success'
                        case 'error': return 'alert-danger'
                        case 'info':
                        default: return 'alert-info'
                    }
                }
                ,
                // å¼€å§‹ç¼–è¾‘è¡¨æ ¼åç§°
                startEditingTableName() {
                    this.tableNameInput = this.currentTable.table_type || '';
                    this.editingTableName = true;

                    // åœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸèšç„¦åˆ°è¾“å…¥æ¡†
                    this.$nextTick(() => {
                        if (this.$refs.tableNameInput) {
                            this.$refs.tableNameInput.focus();
                        }
                    });
                },

                // å®Œæˆè¡¨æ ¼åç§°ç¼–è¾‘
                finishEditingTableName() {
                    if (this.tableNameInput.trim() !== '' &&
                        this.tableNameInput !== this.currentTable.table_type) {
                        // æ›´æ–°è¡¨æ ¼åç§°
                        this.currentTable.table_type = this.tableNameInput.trim();
                        this.hasChanges = true;
                        this.showStatusMessage('è¡¨æ ¼åç§°å·²æ›´æ–°', 'success');
                    }

                    // é‡ç½®ç¼–è¾‘çŠ¶æ€
                    this.editingTableName = false;
                    this.tableNameInput = '';
                }
            }
        }

        // åˆ›å»ºVueåº”ç”¨
        new Vue({
            el: '#app',
            components: {
                TableEditor
            },
            template: '<table-editor></table-editor>'
        })
    </script>

    <!-- Bootstrapå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- å¼•å…¥Bootstrapçš„JavaScriptå’Œç›¸å…³ä¾èµ– -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
</body>

</html>